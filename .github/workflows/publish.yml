name: "Publish"

on:
  workflow_dispatch:
    inputs:
      deploy-to:
        description: "Choose whether to deploy to test or prod"
        type: environment
        default: "prod"
      branch:
        description: "Choose the branch to release from"
        type: string
        default: "main"

# don't attempt to release the same target in parallel
concurrency:
  group: ${{ github.workflow }}-${{ inputs.deploy-to }}
  cancel-in-progress: true

jobs:
  unit-tests:
    if: ${{ success() && failure() }}  # skip tests for now to test publishing
    uses: ./.github/workflows/unit-tests.yml
    with:
      branch: ${{ inputs.branch }}

  integration-tests:
    if: ${{ success() && failure() }}  # skip tests for now to test publishing
    uses: ./.github/workflows/integration-tests.yml
    with:
      branch: ${{ inputs.branch }}
      repository: ${{ github.repository }}
    secrets: inherit

  publish-dbt-athena:
    # needs: [unit-tests, integration-tests]  # skip tests for now to test publishing
    uses: ./.github/workflows/publish-pypi.yml
    with:
      deploy-to: ${{ inputs.deploy-to }}
      branch: ${{ inputs.branch }}

  publish-dbt-athena-community:
    # dbt-athena-community is hard pinned to dbt-athena to ensure they are the same
    # this means we need to finish publishing dbt-athena before starting to build dbt-athena-community
    needs: publish-dbt-athena
    uses: ./.github/workflows/publish-pypi.yml
    with:
      package: "dbt-athena-community"
      deploy-to: ${{ inputs.deploy-to }}
      branch: ${{ inputs.branch }}
